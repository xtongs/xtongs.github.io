<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Calendar</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="dist/style.min.css">
</head>
<body>
<form action="" method="post">
    <input type="hidden" name="pokeDate" value=""/>
    <input type="hidden" name="pokeDateLunar" value="0"/>
    <input type="hidden" name="gender" value="female"/>
    <input type="hidden" name="constellation" value=""/>
    <div id="poke">
        <div class="lights">
            <div>
                <div class="light"></div>
                <div class="light"></div>
                <div class="light"></div>
                <div class="light"></div>
                <div class="light"></div>
                <div class="light"></div>
                <div class="light"></div>
                <div class="light"></div>
                <div class="light"></div>
                <div class="light"></div>
                <div class="light"></div>
            </div>
        </div>
        <img class="egg" src="image/egg.png"/>
        <img class="egg2" src="image/egg2.png"/>
        <img class="stars" src="image/stars.png"/>
        <img class="star1" src="image/star1.png"/>
        <img class="star2" src="image/star2.png"/>
        <img class="title" src="image/title.png"/>
        <div class="date"><span></span>年<span></span>月<span></span>日</div>
        <div class="gender">
            <span>
                <img src="image/gender-male.png"/><img src="image/gender-males.png"/>
            </span>
            <span class="selected">
                <img src="image/gender-female.png"/><img src="image/gender-females.png"/>
            </span>
        </div>
        <img class="shell" src="image/shell.png"/>
        <a class="next">下一步</a>
        <div class="keyboard">
            <div class="keyhead">
                <div class="checkbox">
                    <img src="image/check.png"/><img src="image/checked.png"/>农历
                </div>
                <a class="button">确定</a>
            </div>
            <div class="keybody">
                <div class="scrollbg">
                    <div class="scrollrow"><div></div><div></div><div></div></div>
                    <div class="scrollrow"><div></div><div></div><div></div></div>
                    <div class="scrollrow"><div></div><div></div><div></div></div>
                    <div class="scrollrow"><div></div><div></div><div></div></div>
                </div>
                <div class="scrollcontent">
                    <div class="scrollcol">
                        <ul>
                        </ul>
                    </div>
                    <div class="scrollcol">
                        <ul>
                        </ul>
                    </div>
                    <div class="scrollcol">
                        <ul>
                        </ul> 
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="picker">
        <img class="cloud" src="image/cloud.png"/>
        <img class="shuffle" src="image/shuffle.png"/>
        <div class="ring">
            <div></div>
        </div>
        <div class="ring">
            <div></div>
        </div>
        <div class="ring">
            <div></div>
        </div>
        <div class="ring">
            <div></div>
        </div>
        <div class="constellations">
            <div>
                <div><div>
                    <h3>白羊座</h3>
                    <h3>白羊座</h3>
                    <h4>3.21 - 4.19</h4>
                </div></div>
                <div><div>
                    <h3>金牛座</h3>
                    <h3>金牛座</h3>
                    <h4>4.20 - 5.20</h4>
                </div></div>
                <div><div>
                    <h3>双子座</h3>
                    <h3>双子座</h3>
                    <h4>5.21 - 6.21</h4>
                </div></div>
                <div><div>
                    <h3>巨蟹座</h3>
                    <h3>巨蟹座</h3>
                    <h4>6.22 - 7.22</h4>
                </div></div>
                <div><div>
                    <h3>狮子座</h3>
                    <h3>狮子座</h3>
                    <h4>7.23 - 8.22</h4>
                </div></div>
                <div><div>
                    <h3>处女座</h3>
                    <h3>处女座</h3>
                    <h4>8.23 - 9.20</h4>
                </div></div>
                <div><div>
                    <h3>天秤座</h3>
                    <h3>天秤座</h3>
                    <h4>9.23 - 10.23</h4>
                </div></div>
                <div><div>
                    <h3>天蝎座</h3>
                    <h3>天蝎座</h3>
                    <h4>10.24 - 11.22</h4>
                </div></div>
                <div><div>
                    <h3>射手座</h3>
                    <h3>射手座</h3>
                    <h4>11.23 - 12.21</h4>
                </div></div>
                <div><div>
                    <h3>摩羯座</h3>
                    <h3>摩羯座</h3>
                    <h4>12.22 - 1.19</h4>
                </div></div>
                <div><div>
                    <h3>水瓶座</h3>
                    <h3>水瓶座</h3>
                    <h4>1.20 - 2.18</h4>
                </div></div>
                <div><div>
                    <h3>双鱼座</h3>
                    <h3>双鱼座</h3>
                    <h4>2.19 - 3.20</h4>
                </div></div>
            </div>
        </div>
        <div class="roles">
            <div class="rolesrow">
            </div>
            <div class="rolesrow">
            </div>
        </div>
        <a class="nnext">下一步</a>
    </div>
    <script src="dist/libs.min.js"></script>
    <script>
        var debug = false;
        $(function(){
            // 我的破壳日
            var $poke = $('#poke');
            var $picker = $('#picker');
            var $dates = $('.date').find('span');
            var $gender = $('.gender');
            var $next = $('.next');
            var $checkbox = $('.checkbox');
            var $keyboard = $('.keyboard');
            var $button = $('.button');
            var $scrollcol = $('.scrollcol');

            var $pokeDate = $('input[name=pokeDate]');
            var $pokeDateLunar = $('input[name=pokeDateLunar]');

            var scrolls = [];
            var labels = ['年','月','日'];
            var starts = [1920,1,1];
            var lengths = [,12,31];
            var ends = [new Date().getFullYear(),12,31];
            var date = [1990,7,15];
            var isSolar = true;

            // TODO for debug
            if(debug){
                $poke.hide();
                $picker.addClass('show');
                return false;
            }

            init();
            // 初始化运行
            function init(){
                // 农历选择
                $checkbox.click(function(){
                    $(this).toggleClass('checked');
                    if($(this).hasClass('checked')){
                        changeLunar();
                        $pokeDateLunar.val(1);
                    }else{
                        changeSolar();
                        $pokeDateLunar.val(0);
                    }
                });
                // 滚动组件初始化
                $scrollcol.each(function(i,d){
                    // 初始化时滚动到日期列表中间
                    var length = ends[i]-starts[i]+1;
                    fillScroll(d,labels[i],starts[i],length);
                    scrolls[i] = initScroll(d,date[i]-starts[i]);
                    fillDate(i,date[i]);
                    // 滚动结束事件
                    $(d).data('num',date[i]).on('changeDate',function(){
                        // iscroll bug，初始化时触发了scrollEnd事件，在这里做判断
                        if(true){
                            var i = $(this).index();
                            var num = $(this).data('num');
                            if(i==1){
                                changeMonth(num);
                            }
                            fillDate(i,num);
                        }
                    });
                });
                // 点击确定
                $button.click(function(){
                    $keyboard.hide();
                    $gender.addClass('show').find('span').click(function(){
                        $gender.find('span').removeClass('selected');
                        $(this).addClass('selected');
                        if($(this).index()==0){
                            $('input[name=gender]').val('male');
                        }else{
                            $('input[name=gender]').val('female');
                        }
                    });
                    $next.addClass('show').click(function(){
                        $poke.addClass('hide');
                        $picker.addClass('show');
                    });
                });
            }
            // 将已选择的日期转换成农历
            function changeLunar(){
                isSolar = false;
                changeMonth(date[1]);
            }
            // 将已选择的日期转换成阳历
            function changeSolar(){
                isSolar = true;
                changeMonth(date[1]);
            }
            // 改变月份
            function changeMonth(month){
                if(isSolar){
                    ends[2] = calendar.solarMonth[month-1];
                }else{
                    ends[2] = calendar.monthDays(date[0],date[1]);
                }
                changeDay(date[2],ends[2]);
            }
            // 改变天数
            function changeDay(nowNum,sumNum){
                var $lis = $($scrollcol[2]).find('li');
                var lisrearindex = $lis.get().length - 2;
                $lis.show();
                if(nowNum > sumNum){
                    var extra = nowNum - sumNum;
                    nowNum = sumNum;
                    while(extra>0){
                        $($lis.get()[lisrearindex-extra]).hide();
                        extra--;
                    }
                }else if(sumNum<lengths[2]){
                    var extra = lengths[2] - sumNum;
                    while(extra>0){
                        $($lis.get()[lisrearindex-extra]).hide();
                        extra--;
                    }
                }
                setTimeout(function(){
                    scrolls[2].refresh();
                    scrolls[2].goToPage(0, nowNum-1, 100);
                },0);
            }
            // 填入日期
            function fillDate(i,num){
                var dom = $dates[i];
                if(!isNaN(num)){
                    $(dom).text(num);
                    date[i] = num;
                    var dateStr = '';
                    for(var i=0;i<3;i++){
                        dateStr += (date[i]||'') + labels[i];
                    }
                    $pokeDate.val(dateStr);
                }
            }
            // 将年月日填入scroll wrapper
            function fillScroll(wrapper,label,start,length){
                var before = $('<li>&nbsp;</li>');
                var after = $('<li>&nbsp;</li><li>&nbsp;</li>');
                var lis = '';
                for(var i=0;i<length;i++){
                    lis += ('<li data-num='+(start+i)+'>'+(start+i>9?'':'&nbsp;')+(start+i)+label+'</li>');
                }
                $(wrapper).find('ul').empty().append(before,lis,after);
            }
            // 我的破壳日选择日期滚动
            function initScroll(wrapper,initNum){
                var lis = $(wrapper).find('li');
                if(lis.length){
                    var scroll = new IScroll(wrapper,{
                        scrollbars: false,
                        bounce: false,
                        momentum: true,
                        deceleration: 0.001,
                        snap: 'li'
                    });
                    scroll.on('scrollEnd', function(){
                        var index = this.currentPage.pageY + 1;
                        var num = $(lis[index]).data('num');
                        var $div = $(lis).closest('div');
                        if(num){
                            $div.data('num',num);
                            $div.trigger('changeDate');
                        }
                    });
                    scroll.goToPage(0, initNum, 100);
                    return scroll;
                }
            }
            
        });

        
        // 选星座
        $(function(){
            var $picker = $('#picker');
            var $shuffle = $('.shuffle');
            var $rings = $('.ring');
            var $thering = $('.thering');
            var $nnext = $('.nnext');
            var $constellations = $('.constellations>div>div');
            var $constellation = $('input[name=constellation]');
            var $rolesrow = $('.rolesrow');
            var rolenames = ['papa','mama','grandpa','baby','friend'];
            var rolepool = [];
            var rolegender = ['m','f','m','m','f'];
            var cosnames = ['aries','taurus','gemini','cancer','Leo','virgo','libra','scorpio','sagittarius','capricornus','aquarius','pisces'];
            var cosfiles = ['1','2','3','4','5','6','7','8','9','10','11','12'];
            var classes = ['top1','top2','top3','top4','top5'];
            var constellation = [];
            var initiated = false;
            var ready = false;

            init();
            // 初始化
            function init(){
                // 初始化角色池
                for(var p=0;p<rolenames.length;p++){
                    rolepool.push(p);
                }
                shuffle();
                // 点击切换
                $shuffle.click(function(){
                    $(this).toggleClass('do');
                    shuffle();
                });

                // 拖拽拉环
                $rings.each(function(i,r){
                    dragRing($(r).find('img'));
                });

                // 全部结束，提交表单
                $nnext.click(function(){
                    if(ready){
                        $('form').submit();
                    }else{
                        return false;
                    }
                });
            }
            // 生成1到5的随机数数组
            function rand(a){
                // 乱序a数组
                for(var j, x, i = a.length; i; j = parseInt(Math.random() * i), x = a[--i], a[i] = a[j], a[j] = x);
                return a;
            }
            // 拉环随机出现
            function shuffle(){
                // 角色池打乱重排
                rolepool = rand(rolepool);
                var classarr = rand(classes);
                for(var i=0;i<classes.length;i++){
                    if($($rings[0]).hasClass(classes[i])){
                        having = true;
                    }
                }
                // 非首次出现，延时1s
                if(initiated){
                    // 非首次,打乱图片顺序
                    $rings.removeClass(classes.join(' '));
                    setTimeout(function(){
                        var offset = 0;
                        // 排除掉失效的拉环
                        $rings.each(function(i,r){
                            var index = rolepool[i - offset];
                            if(!$(r).hasClass('none') && rolenames[index]){
                                $(r).find('img').data('role',index);
                                $(r).find('img').attr('src','image/ring-'+rolenames[index]+'.png');
                            }else{
                                offset++;
                            }
                        });
                        addtopclass();
                    },1000);
                }else{
                    initiated = true;
                    // 首次构建拉环dom节点
                    $rings.each(function(i,r){
                        $(r).append(buildRing(rolepool[i]));
                    });
                    addtopclass();
                }
                function addtopclass(){
                    $rings.each(function(i,r){
                        $(r).removeClass('broken').addClass(classarr[i]).data('top',classarr[i]);
                    });
                }                
            }
            // 拖拽拉环
            function dragRing(img){
                var ring = img.parent();
                var dom = img.get(0);
                var dx = 0;
                var dy = 0;
                var scale = 1.5;
                touch.on(dom, 'touchstart', function(ev){
                    ring.data('initY',Number(img.css('-webkit-transform').split(', ').pop().split(')')[0]));
                    ring.addClass('broken');
                    ev.preventDefault();
                });
                // 拖拽 the ring 图像
                touch.on(dom, 'drag', function(ev){
                    dy = ring.data('initY');
                    var offx = dx + ev.x + 'px';
                    var offy = dy + ev.y + 'px';
                    dom.style.webkitTransform = 'translate(' + offx + ',' + offy + ')';
                    dom.style.webkitTransform += 'scale(' + scale + ',' + scale + ')';

                    // 图片中心点的绝对位置
                    var top = img.offset().top + img.offset().height/2;
                    var left = img.offset().left + img.offset().width/2;
                    
                    img.data('cos','');
                    // 星座选择面板各选项的位置计算
                    $constellations.each(function(i,c){
                        $(c).removeClass('selected');
                        var o = $(c).offset();
                        if(top > o.top && top < (o.top + o.height) && left > o.left && left < (o.left + o.width) ){
                            $(c).addClass('selected');
                            img.data('cos',i);
                        }
                    })
                });
                touch.on(dom, 'touchend', function(ev){
                    dx = 0;
                    dy = ring.data('initY');
                    dom.style.webkitTransform = '';
                    // 如果有选中星座
                    if(parseInt(img.data('cos'))>=0){
                        pickRole(img.data('role'),img.data('cos'));
                        ring.addClass('new').removeClass(ring.data('top'));
                        // 选择角色之后，在角色池中删除该index值，添加选择剩下的(第4个，index为3)index，如果没有则不再补充拉环
                        rolepool.splice($.inArray(img.data('role'),rolepool),1);
                        if(rolepool[3]>=0){
                            changeRing(ring,rolepool[3]);
                        }else{
                            ring.addClass('none');
                        }
                        if(rolepool.length == 0){
                            $shuffle.addClass('hide');
                        }
                    }
                    ring.removeClass('broken');
                });
            }
            // 选择成功
            function pickRole(roleindex,cosindex){
                $constellations.removeClass('selected');
                var role = buildRole(roleindex,cosindex);
                var n = rolenames.length - rolepool.length;
                if(n==0||n==1||((n%2) && n>3)){
                    $rolesrow.first().append(role);
                }else{
                    $rolesrow.last().append(role);
                }
                setTimeout(function(){
                    role.addClass('show');
                },100);
                $nnext.addClass('show');
                // 写入星座表单值
                var roleobj = {
                    "name" : rolenames[roleindex],
                    "cos" : cosnames[cosindex]
                }
                constellation.push(roleobj);
                $constellation.val(JSON.stringify(constellation));
                // 提交表单
                ready = true;
            }
            // 选择成功后更换拉环
            function changeRing(ring,i){
                var img = ring.find('img');
                img.data('cos','');
                img.data('role',i);
                img.attr('src','image/ring-'+rolenames[i]+'.png');
                setTimeout(function(){
                    ring.removeClass('new').addClass(ring.data('top'));
                },100);
            }
            // 构建角色拉环dom节点
            function buildRing(roleindex){
                if(rolenames[roleindex]){
                    return $('<img data-role="'+roleindex+'" src="image/ring-'+rolenames[roleindex]+'.png"/>')
                }else{
                    return $('');
                }
            }
            // 构建角色dom节点
            function buildRole(roleindex,cosindex){
                if(rolenames[roleindex] && cosnames[cosindex]){
                    return $('<div class="role"><img src="image/role-'+rolenames[roleindex]+'.png"/><img src="image/icon-'+cosfiles[cosindex]+'-'+rolegender[roleindex]+'.png"/></div>');
                }else{
                    return $('');
                }
            }

        });
    </script>
</form>
</body>
</html>